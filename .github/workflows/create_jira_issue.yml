name: Create Jira Issue on GitHub Issue Open

on:
  issues:
    types:
      - opened

jobs:
  create-jira-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Jira ì´ìŠˆ ìƒì„±
        id: jira_issue_creation
        uses: actions/github-script@v6
        with:
          script: |
            const JIRA_API_ENDPOINT = `${process.env.JIRA_BASE_URL}/rest/api/3/issue`;
            const JIRA_PROJECT_KEY = process.env.JIRA_PROJECT_KEY;

            // GitHub Issue ì œëª©ì—ì„œ TYPE ì¶”ì¶œ (ì²« ë²ˆì§¸ ëŒ€ê´„í˜¸)
            let TYPE = (context.payload.issue.title.match(/\[(.*?)\]/) || [])[1];
            if (!TYPE) TYPE = "feature";
            TYPE = TYPE.toLowerCase();
            core.setOutput('type', TYPE);

            // Jira ì´ìŠˆ ìƒì„± ë°ì´í„°
            const issueData = {
              fields: {
                project: { key: JIRA_PROJECT_KEY },
                summary: context.payload.issue.title,
                issuetype: { name: 'ìž‘ì—…' },
                description: {
                  type: 'doc',
                  version: 1,
                  content: [
                    {
                      type: "paragraph",
                      content: [
                        {
                          type: "text",
                          text: "GitHub Issue",
                          marks: [
                            {
                              type: "link",
                              attrs: { href: context.payload.issue.html_url }
                            }
                          ]
                        }
                      ]
                    }
                  ]
                }
              }
            };
            
            // Jira API í˜¸ì¶œ
            const response = await fetch(JIRA_API_ENDPOINT, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${Buffer.from(`${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(issueData),
            });
            
            if (!response.ok) {
              const errorBody = await response.text();
              throw new Error(`Jira API failed: ${response.statusText}. Response: ${errorBody}`);
            }
            
            const jiraIssue = await response.json();
            console.log(`Jira Issue created: ${jiraIssue.key}`);
            core.setOutput('jiraKey', jiraIssue.key);
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}

      - name: GitHub ì´ìŠˆì— Jira í‚¤ ì¶”ê°€
        uses: actions/github-script@v6
        with:
          script: |
            const jiraKey = '${{ steps.jira_issue_creation.outputs.jiraKey }}';

            // GitHub ì´ë²¤íŠ¸ payloadì—ì„œ issue ê°€ì ¸ì˜¤ê¸°
            const issue = context.payload.issue;
            if (!issue) {
              throw new Error("ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì´ìŠˆ ì´ë²¤íŠ¸ì— ì˜í•´ íŠ¸ë¦¬ê±°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
            }

            // ì œëª© ì•žì— [JIRA-KEY] ë¶™ì´ê¸°
            const title = `[${jiraKey}]${issue.title}`;
            
            // ë ˆì´ë¸” ì¶”ê°€
            const labels = [...(issue.labels?.map(l => l.name) || []), 'jira'];

            // GitHub ì´ìŠˆ ì—…ë°ì´íŠ¸
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              title: title,
              labels: labels
            });

      - uses: actions/checkout@v4
        with:
          ref: develop

      - name: Jira ì´ìŠˆ ê¸°ë°˜ ë¸Œëžœì¹˜ ìƒì„±
        run: |
          TYPE=${{ steps.jira_issue_creation.outputs.type }}
          JIRA_KEY=${{ steps.jira_issue_creation.outputs.jiraKey }}
          ISSUE_NUMBER=${{ github.event.issue.number }}
          BRANCH_NAME="$TYPE/$JIRA_KEY-$ISSUE_NUMBER"
          git checkout develop
          git pull
          git checkout -b $BRANCH_NAME
          git push origin $BRANCH_NAME

      - name: GitHub ì´ìŠˆì— ëŒ“ê¸€ ì¶”ê°€
        uses: actions/github-script@v6
        with:
          script: |
            const jiraKey = '${{ steps.jira_issue_creation.outputs.jiraKey }}';
            const issueNumber = ${{ github.event.issue.number }};
            const branchName = process.env.BRANCH_NAME;
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber
            });
            const body = [
              `ðŸ”€ ë¸Œëžœì¹˜: ${branchName}`,
              `âš¡ Jira ì´ìŠˆ ìƒì„±: [${jiraKey}](${process.env.JIRA_BASE_URL}/browse/${jiraKey})`
            ].join("\n")
            
            if (!comments.data.some(c => c.body.includes(jiraKey))) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: body
              });
            }
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          BRANCH_NAME: ${{ env.BRANCH_NAME }}

name: Create Jira Issue on GitHub Issue Open

on:
  issues:
    types:
      - opened

jobs:
  create-jira-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Create Issue in Jira (via REST API)
        id: jira_issue_creation
        uses: actions/github-script@v6
        with:
          # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ì„ ìœ„í•´ Node.js í™˜ê²½ì—ì„œ JIRA_BASE_URL í•„ìš”
          script: |
            const JIRA_API_ENDPOINT = `${process.env.JIRA_BASE_URL}/rest/api/3/issue`;
            const JIRA_PROJECT_KEY = process.env.JIRA_PROJECT_KEY;
            
            // Jira ìš”ì²­ ë³¸ë¬¸ (Body) êµ¬ì„±
            const issueData = {
              fields: {
                project: { key: JIRA_PROJECT_KEY },
                summary: context.payload.issue.title,
                issuetype: { name: 'Story' }, // ðŸ‘ˆ ì´ìŠˆ íƒ€ìž… ì„¤ì •
                description: {
                  type: 'doc',
                  version: 1,
                  content: [
                    {
                      type: 'paragraph',
                      content: [{
                        type: 'text',
                        text: `[GitHub Issue Link](${context.payload.issue.html_url})\n\nDescription:\n${context.payload.issue.body}`
                      }]
                    }
                  ]
                }
              }
            };
            
            // Jira API í˜¸ì¶œ (fetch ì‚¬ìš©)
            const response = await fetch(JIRA_API_ENDPOINT, {
              method: 'POST',
              headers: {
                'Authorization': `Basic ${Buffer.from(`${process.env.JIRA_USER_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(issueData),
            });
            
            if (!response.ok) {
              const errorBody = await response.text();
              throw new Error(`Jira API failed: ${response.statusText}. Response: ${errorBody}`);
            }
            
            const jiraIssue = await response.json();
            
            // ë‹¤ìŒ ë‹¨ê³„ì—ì„œ ì‚¬ìš©í•  Jira Keyë¥¼ ì¶œë ¥ (outputs)
            console.log(`Jira Issue created: ${jiraIssue.key}`);
            core.setOutput('issue', jiraIssue.key); # ðŸ‘ˆ ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì°¸ì¡°í•˜ê¸° ìœ„í•´ issue keyë¥¼ outputìœ¼ë¡œ ì„¤ì •

        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ env.JIRA_PROJECT_KEY }} # ðŸ‘ˆ ìƒìœ„ env ë³€ìˆ˜ ì‚¬ìš©

      - name: Add Jira Key to Github Issue
        uses: actions/github-script@v6
        with:
          script: |
            const jiraKey = '${{ steps.jira_issue_creation.outputs.issue }}';
            
            // 1. GitHub ì´ìŠˆ ë³¸ë¬¸ì— Jira ë§í¬ ì¶”ê°€
            const body = `${{ github.event.issue.body }}\n\n---
            **[Jira Issue](${ process.env.JIRA_BASE_URL }/browse/${jiraKey})**`;
            
            // 2. ì¤‘ë³µ ìƒì„± ë°©ì§€ ë ˆì´ë¸” ë° GitHub ë ˆì´ë¸” ì¶”ê°€
            const labels = [...github.event.issue.labels.map(l => l.name), 'synced-from-jira'];
            
            github.rest.issues.update({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body,
              labels: labels
            });
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
